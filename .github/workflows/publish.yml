name: Publish Texture Pack to Modrinth & CurseForge

on:
  release:
    types: [published]

jobs:
  publish:
    name: Package and Publish Texture Pack
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate JSON Files
        run: find . -name "*.json" -exec jq empty {} \;

      - name: Install RPValid
        run: curl -L https://github.com/IMP1/rpvalid/releases/latest/download/rpvalid-linux -o rpvalid && chmod +x rpvalid

      - name: Validate Resource Pack
        run: ./rpvalid --path .

      - name: Package Texture Pack
        run: zip -r texturepack.zip . -x ".git/*"

      - name: Generate Changelog
        run: |
          if [[ -z "${{ github.event.release.body }}" ]]; then
            git log $(git describe --tags --abbrev=0 @^)..@ --oneline > changelog.txt
          else
            echo "${{ github.event.release.body }}" > changelog.txt
          fi

      - name: Publish to Modrinth
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: rERW3QhL
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          github-tag: ${{ github.event.release.tag_name }}
          name: ${{ github.event.release.name }}
          version: ${{ github.event.release.tag_name }}
          changelog: ${{ github.event.release.body }}
          type: resourcepack
          loaders: minecraft
          game-versions: |-
            1.19.3
            1.19.4
          files: texturepack.zip

      - name: Publish to CurseForge
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          curseforge-id: 123456
          curseforge-token: ${{ secrets.CURSEFORGE_TOKEN }}
          files: texturepack.zip
